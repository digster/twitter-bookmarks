# 2026-02-14 — Incremental Bookmark Fetching

## What was done

### Session 1: Initial incremental fetching implementation

Implemented incremental bookmark fetching to avoid re-downloading all 900+ bookmarks on every `fetch` call. Added `known_ids`/`since_date` early-stop to client, bookmark JSON store to state, merge flow to CLI.

### Session 2: Fix — Markdown as source of truth

Rewrote the incremental fetch to use `bookmarks.md` as the single source of truth, fixing several critical bugs:

**Bugs fixed:**
1. **Overwrites 899 bookmarks with ~40** — The merge-from-JSON-store approach failed when `bookmarks.json` didn't exist, losing all existing bookmarks.
2. **Wrong "2 new" count** — Count depended on `processed_ids.json` which was out of sync.
3. **Unnecessary header lines** — Removed `# Twitter/X Bookmarks`, `*Last updated...*`, `## Date Group` headers from output.
4. **Missing unique identifier** — Added `- **ID:** {tweet_id}` to each bookmark entry.

**Changes:**

1. **markdown.py** — Removed headers and date-group lines from `render_bookmarks_file()`. Added `- **ID:** {tweet_id}` metadata line. Added three helpers:
   - `strip_legacy_headers()` — strips old-format headers from existing content
   - `extract_ids_from_markdown()` — extracts tweet IDs from `**ID:**` lines (falls back to `status/{id}` URLs)
   - `extract_latest_date()` — extracts date from first `**Date:**` line

2. **state.py** — Removed bookmark JSON store (`_bookmark_to_dict`, `_dict_to_bookmark`, `load_bookmarks`, `save_bookmarks`, `merge_bookmarks`). Kept `processed_ids.json` for `status` command.

3. **cli.py** — Rewrote fetch flow:
   - Incremental: read .md → extract known_ids + latest_date → fetch → dedup → prepend new
   - Full: fetch all → render → overwrite
   - `--since` filters truly-new bookmarks before prepending
   - Count reports `len(truly_new)` — what actually gets prepended

4. **viewer.html** — Derives `dateGroup` from `bm.date` when no `## Date` header exists (backward compat). Parses `- **ID:**` line.

5. **Tests** — Updated test_markdown.py (no-header format, new function tests for strip_legacy_headers, extract_ids_from_markdown, extract_latest_date). Removed TestBookmarkStore from test_state.py.

## Test results

80/81 passing. 1 pre-existing failure in `test_status_with_config` (logging I/O error, unrelated).
