# 2026-02-11 — Initial Build + Fetch Delay & Count

## Summary
Built the Twitter/X Bookmarks Backup CLI tool from scratch. A Python CLI that fetches bookmarks from Twitter's internal GraphQL API and exports them to a single `bookmarks.md` file.

## Key Decisions
- **Direct API calls** via `httpx` instead of `bird` CLI (avoids Node.js dependency)
- **Cookie-based auth** using `auth_token` + `ct0` from browser DevTools
- **Single markdown output** file grouped by date, newest first
- **State tracking** via `.state/processed_ids.json` for incremental fetches

## Files Created
- `src/twitter_bookmarks/` — 8 modules (cli, config, client, parser, models, markdown, state, logging_config)
- `tests/` — 5 test files with 42 passing tests
- `pyproject.toml` — deps: httpx, click, tomli-w
- `README.md`, `ARCHITECTURE.md`, `CLAUDE.md`, `PROMPT.md`

## Fetch Delay & Count Feature (Session 2)
Added configurable delay between API requests and `--count` flag:
- `config.py`: Added `fetch_delay: float = 2.0` to `AppConfig`, `[fetch]` TOML section
- `client.py`: Added `delay` and `max_count` params to `fetch_all_bookmarks()`
- `cli.py`: Added `--count`/`-n` and `--delay` CLI options to `fetch` command
- Config hierarchy: CLI flag > config file > default (2.0s)
- 4 new tests (delay mock, max_count stop, max_count truncate, CLI help flags)

## Query ID & 404 Handling (Session 3)
Added configurable query ID and 404 error handling for stale GraphQL IDs:
- `client.py`: 404 response now raises descriptive error with instructions to update query ID. `TwitterClient` accepts `query_id` param (per-instance URL instead of module constant).
- `config.py`: Added `query_id: str | None` to `AppConfig`, stored under `[api]` section in TOML.
- `cli.py`: Added `--query-id-only` flag to `setup` for quick query ID updates without re-entering auth tokens. Full `setup` now prompts for optional query ID.
- `cli.py` (`fetch`): Passes `config.query_id` to `TwitterClient`.
- 2 new tests: `test_stale_query_id_raises`, `test_custom_query_id`
- Updated `ARCHITECTURE.md` and `README.md` with query ID docs and 404 troubleshooting.

## Resilient User Extraction & --dump-raw (Session 4)
Fixed "Unknown" author usernames — all bookmarks showed `@unknown` because the parser had a single hardcoded key path for user data that didn't match the live API response structure.

### Changes
- **`parser.py`**: Extracted `_extract_user()` helper with multi-path fallback:
  1. `core.user_results.result.legacy` (standard)
  2. `core.user_result.result.legacy` (singular variant)
  3. `core.user_results.result` directly (flattened, no `legacy` wrapper)
  4. `_deep_find_user()` recursive search (last resort, max 6 levels)
  - Added `logger.debug()` calls showing actual keys at each nesting level
  - Added `logger.warning()` when username falls back to "unknown"
  - Quoted tweet user extraction also uses `_extract_user()` now
- **`client.py`**: Added `capture_raw` param + `raw_responses` list to capture raw API JSON
- **`cli.py`**: Added `--dump-raw <path>` option to `fetch` command — saves raw API responses + entries to JSON for debugging
- **Tests**: 11 new tests (7 for `_extract_user`, 4 for `_deep_find_user`, 1 CLI test for `--dump-raw`)
- **Fixture**: Added `bookmarks_response_singular_user.json`

## HTML Bookmarks Viewer (Session 5)
Built a standalone HTML viewer (`viewer.html`) for browsing exported bookmarks visually.

### Architecture
- Single self-contained HTML file (~25 KB) — no server, no external dependencies, no build step
- Client-side markdown parser: line-by-line state machine reversing `markdown.py` format
- Rendering pipeline: parse → filter/sort → batch render (50 cards via IntersectionObserver)
- CSS custom properties theme system with `[data-theme]` + localStorage persistence

### Features
- Drag-and-drop / file picker for `.md` file loading
- Card-based UI grouped by date with colored avatar initials
- Full-text search (AND logic, 250ms debounce) across username, display name, tweet text
- Sort toggle (newest/oldest first)
- Dark/light theme with `prefers-color-scheme` detection + localStorage persistence
- Photo grids (1-4 images in responsive grid), video/GIF thumbnails with play overlay
- Reply-to and quote-tweet badges
- External links with domain names and globe icon
- "Show more" truncation for tweets >280 chars
- Infinite scroll via IntersectionObserver sentinel
- Responsive layout: 3-col → 2-col → 1-col
- Stats bar: total count, date range, filtered count
- Keyboard shortcuts: `/` to focus search, `Escape` to clear
- Scroll-to-top button
- Lazy image loading with error fallbacks

### Files
- `viewer.html` — Created (the viewer)
- `README.md` — Added Viewer section
- `ARCHITECTURE.md` — Added Viewer section with architecture details
- `PROMPT.md` — Logged prompt

### Verified
- 899 bookmarks parse and render correctly
- Search, sort, theme, infinite scroll, media grids, badges all tested in browser

## List View Mode for Viewer (Session 6)
Added a compact list view mode to the HTML bookmarks viewer as the new default view.

### Architecture
- View mode system follows theme pattern: `[data-view]` attribute on `<html>`, persisted in `localStorage('bookmarks-viewer-view')`
- Two render paths (`renderListCard` / `renderGridCard`) with shared helpers (`buildMediaHtml`, `buildBadgesHtml`, `buildLinksHtml`)
- Event delegation on `mainContent` for list row expand/collapse (single listener for all cards)
- `event.stopPropagation()` on links/badges inside list cards prevents expand toggle on link clicks

### List Mode Features
- Compact single-column rows: `[avatar] @username · Display Name · date [badges] / text (2-line clamp) / media indicators / [→ link]`
- Click row to expand: reveals full text, media grid, and links inline
- Click again to collapse
- Media indicators: SVG icons with counts (photo, video, GIF) instead of full media grid
- Link count indicator
- No card shadows/borders — just subtle bottom border between rows, background highlight on hover
- Expanded state gets card-like border/background treatment

### Changes
- `viewer.html`: ~330 lines added (CSS list mode styles, view toggle button HTML, JS state/render/event code)
- `ARCHITECTURE.md`: Updated viewer section with view mode system and render path docs
- `README.md`: Updated viewer features with list/grid toggle
- `PROMPT.md`: Logged prompt

### Verified in Browser
- List mode renders as default on fresh load
- Toggle switches between list ↔ grid correctly
- Grid mode unchanged from before
- Search filters correctly in list mode
- Expand/collapse works (click row to expand, click again to collapse)
- Links/badges clickable without triggering expand
- localStorage persists view mode across reloads
- Date group labels work in both modes

## List View UX Polish (Session 7)
Fixed three UX issues in the list view mode of the HTML bookmarks viewer.

### Changes
- **`viewer.html` CSS**: Added `[data-view="list"] .main` and `.stats-bar` max-width 650px for narrow centered column (matches Twitter's feed width)
- **`viewer.html` CSS**: Added `max-width: 500px` to `.list-expanded-content .media-grid` to bound expanded images
- **`viewer.html` CSS**: Added `.list-thumbnail` styles — 16:9 aspect ratio, 350px max-width, rounded corners, count badge overlay, video play overlay, hidden when card expanded
- **`viewer.html` CSS**: Added mobile responsive rule (`max-width: 100%` for thumbnails at 480px)
- **`viewer.html` JS**: Added thumbnail generation in `renderListCard()` — finds first photo or video, renders preview with lazy loading and onerror fallback; shows `+N` count badge for multi-image tweets, play icon overlay for video/GIF

### Verified
- List view tweets centered at ~650px (not stretching to 1400px)
- Thumbnail previews show in collapsed cards for bookmarks with media
- Thumbnails hide when card is expanded (full media grid takes over)
- Expanded images bounded at 500px max
- Grid view unaffected
- Mobile responsive at 480px breakpoint

## Pagination for Viewer (Session 8)
Replaced infinite scroll with traditional numbered pagination in the bookmarks viewer.

### Changes
- **`viewer.html` CSS**: Removed `.sentinel` style. Added `.pagination-wrapper`, `.pagination`, `.pagination-btn`, `.pagination-btn.active`, `.pagination-ellipsis` styles with mobile responsive rules at 480px
- **`viewer.html` HTML**: Added `pageSizeSelect` dropdown (20/50/100 per page), `paginationTop` and `paginationBottom` containers, removed sentinel div
- **`viewer.html` JS State**: Replaced `renderedCount`, `BATCH_SIZE`, `observer` with `currentPage`, `pageSize`. Added `paginationTop`, `paginationBottom`, `pageSizeSelect` DOM refs
- **`viewer.html` JS Functions**: Deleted `renderBatch()`, `renderAll()`, `setupInfiniteScroll()`. Added `getTotalPages()`, `getPageSlice()`, `goToPage()`, `syncPageToHash()`, `readPageFromHash()`, `buildPageNumbers()`, `buildPaginationHtml()`, `renderCurrentPage()`, `setupPaginationListeners()`
- **`viewer.html` JS Events**: Page-size change handler saves to localStorage. Arrow key navigation (Left/Right) for pagination. Event delegation on pagination containers for page button clicks
- **`viewer.html` JS Init**: Reads saved `pageSize` from localStorage on init
- **`viewer.html` updateStats()**: Shows "Page X of Y" instead of "Showing X of Y"
- **`viewer.html` performSearch()/sort**: Resets to page 1 on search/sort change
- **`viewer.html` handleFile()**: Reads page from URL hash on load, calls `renderCurrentPage()` + `setupPaginationListeners()`

### Features
- Prev/Next buttons + numbered page buttons with ellipsis for large page counts
- Page-size dropdown (20/50/100) persisted in localStorage
- URL hash persistence (`#page=N`) via `history.replaceState`
- Keyboard navigation: `←`/`→` arrow keys (skipped when in input/select/textarea)
- Date group "(continued)" suffix when a group spans page boundaries
- Pagination controls hidden when 0 or 1 page of results
- Mobile responsive pagination at 480px breakpoint

## Status
- 55/56 tests passing (1 pre-existing failure: `test_status_with_config` — logging to closed file)
- CLI working (`setup`, `fetch`, `status` commands)
- User extraction is now resilient to Twitter API key path changes
- HTML viewer working with list (default) and grid view modes, numbered pagination
